<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Generaci√≥n de PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2d5016;
        }
        .test-button {
            background: #2d5016;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #4a7c59;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .preview {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üìÑ Test de Generaci√≥n de PDF</h1>
    
    <div class="test-section">
        <h2>üîß Configuraci√≥n de Prueba</h2>
        <div>
            <label for="dateFrom">Desde:</label>
            <input type="date" id="dateFrom" value="2024-01-01">
        </div>
        <div>
            <label for="dateTo">Hasta:</label>
            <input type="date" id="dateTo" value="2024-12-31">
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìä Pruebas de PDF</h2>
        <button class="test-button" onclick="testPDFProfessional()">Test PDF Profesional</button>
        <button class="test-button" onclick="testPDFSimple()">Test PDF Simple</button>
        <button class="test-button" onclick="testPDFData()">Test Datos del PDF</button>
        <button class="test-button" onclick="downloadPDF()">Descargar PDF</button>
    </div>
    
    <div class="test-section">
        <h2>üìã Vista Previa de Datos</h2>
        <div id="dataPreview" class="preview">
            <div>Haz clic en "Test Datos del PDF" para ver los datos que se incluir√°n en el PDF</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìù Log de Resultados</h2>
        <div id="testLog" style="background: #f8f8f8; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;">
            <div>Esperando pruebas...</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = `status ${type}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function getParams() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            return new URLSearchParams({
                dateFrom: dateFrom,
                dateTo: dateTo
            });
        }
        
        // Test 1: PDF Profesional
        async function testPDFProfessional() {
            log('üîß Probando generador PDF profesional...', 'info');
            try {
                const params = getParams();
                const response = await fetch(`php/generate_pdf_report.php?${params}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/pdf')) {
                        log('‚úÖ PDF profesional: EXITOSO - Archivo PDF generado', 'success');
                        
                        // Crear enlace de descarga
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'test-pdf-profesional.pdf';
                        a.textContent = 'Descargar PDF Profesional';
                        a.style.display = 'block';
                        a.style.margin = '10px 0';
                        document.body.appendChild(a);
                        
                        setTimeout(() => {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 5000);
                    } else {
                        log('‚ö†Ô∏è PDF profesional: Respuesta no es PDF', 'error');
                    }
                } else {
                    log(`‚ùå PDF profesional: ERROR ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Test 2: PDF Simple
        async function testPDFSimple() {
            log('üîß Probando generador PDF simple...', 'info');
            try {
                const params = getParams();
                const response = await fetch(`php/generate_pdf_simple.php?${params}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        log('‚úÖ PDF simple: EXITOSO - HTML generado', 'success');
                        
                        // Mostrar preview
                        const html = await response.text();
                        const preview = document.getElementById('dataPreview');
                        preview.innerHTML = '<h3>Vista Previa del Reporte HTML:</h3>' + html;
                    } else {
                        log('‚ö†Ô∏è PDF simple: Respuesta no es HTML', 'error');
                    }
                } else {
                    log(`‚ùå PDF simple: ERROR ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Test 3: Datos del PDF
        async function testPDFData() {
            log('üìä Probando datos del PDF...', 'info');
            try {
                const params = getParams();
                const response = await fetch(`debug_reportes_simple.php?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Datos del PDF: EXITOSOS', 'success');
                    
                    // Mostrar datos en preview
                    const preview = document.getElementById('dataPreview');
                    preview.innerHTML = `
                        <h3>Datos que se incluir√°n en el PDF:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                <strong>Ingresos:</strong><br>
                                $${data.kpis.totalIncome?.toLocaleString() || 0}
                            </div>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                <strong>Aportes:</strong><br>
                                $${data.kpis.totalContributions?.toLocaleString() || 0}
                            </div>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                <strong>Socios:</strong><br>
                                ${data.kpis.activeMembers || 0}
                            </div>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                                <strong>Inventario:</strong><br>
                                $${data.kpis.inventoryValue?.toLocaleString() || 0}
                            </div>
                        </div>
                        <h4>Informaci√≥n de Debug:</h4>
                        <pre style="background: #f0f0f0; padding: 10px; border-radius: 3px; font-size: 12px;">${JSON.stringify(data.debug_info, null, 2)}</pre>
                    `;
                } else {
                    log(`‚ùå Datos del PDF: ERROR - ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Test 4: Descargar PDF
        async function downloadPDF() {
            log('üì• Descargando PDF...', 'info');
            try {
                const params = getParams();
                
                // Intentar PDF profesional primero
                try {
                    const response = await fetch(`php/generate_pdf_report.php?${params}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reporte-cooperativa-${new Date().toISOString().split('T')[0]}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        log('‚úÖ PDF descargado exitosamente', 'success');
                        return;
                    }
                } catch (error) {
                    log('‚ö†Ô∏è PDF profesional no disponible, usando simple...', 'info');
                }
                
                // Fallback: PDF simple
                const response = await fetch(`php/generate_pdf_simple.php?${params}`);
                if (response.ok) {
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                    newWindow.print();
                    
                    log('‚úÖ PDF simple abierto para impresi√≥n', 'success');
                } else {
                    log('‚ùå Error descargando PDF', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Ejecutar tests autom√°ticamente al cargar
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando tests de PDF...', 'info');
            
            // Establecer fechas por defecto
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('dateTo').value = lastDay.toISOString().split('T')[0];
            
            setTimeout(() => testPDFData(), 1000);
        });
    </script>
</body>
</html>
